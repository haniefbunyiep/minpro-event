// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  uid            String                @id @default(cuid())
  name           String
  email          String
  username       String
  password       String
  roleId         Int                   @default(3)
  referralCodeId Int
  pointId        Int
  userStatus     UserEmailVerification @default(UNVERIFY)

  point        User_Point    @relation(fields: [pointId], references: [id])
  role         Role          @relation(fields: [roleId], references: [id])
  referralCode Referall_Code @relation(fields: [referralCodeId], references: [id])

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  Review            Review[]
  Promotion         Promotion[]
  Transaction       Transaction[]
  Use_Referral      Use_Referral[]
  User_Voucher      User_Voucher[]
  TransactionDetail TransactionDetail[]
  Use_User_Voucher  Use_User_Voucher[]

  @@map("users")
}

enum UserEmailVerification {
  UNVERIFY
  VERIFIED
}

model User_Point {
  id       Int      @id @default(autoincrement())
  point    Int      @default(0)
  expireAt DateTime @db.Date
  lastAdd  DateTime @db.Date

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  User User[]

  @@map("user_point")
}

model Event_Organizer {
  uid         String              @id @default(cuid())
  name        String
  username    String              @unique
  phoneNumber String?
  email       String
  password    String
  roleId      Int                 @default(2)
  status      EOEmailVerification @default(UNVERIFY)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  role  Role    @relation(fields: [roleId], references: [id])
  Event Event[]

  @@map("event_organizers")
}

enum EOEmailVerification {
  VERIFIED
  UNVERIFY
}

model Referall_Code {
  id           Int    @id @default(autoincrement())
  referallCode String

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  User         User[]
  Use_Referral Use_Referral[]

  @@map("referral_code")
}

model Use_Referral {
  id             Int    @id @default(autoincrement())
  referralCodeId Int
  useBy          String

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  referralCode Referall_Code @relation(fields: [referralCodeId], references: [id])
  user         User          @relation(fields: [useBy], references: [uid])

  @@map("use_referral")
}

model Role {
  id   Int    @id @default(autoincrement())
  name String

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  User            User[]
  Event_Organizer Event_Organizer[]

  @@map("roles")
}

model Event {
  id          Int      @id @default(autoincrement())
  eoUsername  String
  name        String
  startDate   DateTime @db.Date
  endDate     DateTime @db.Date
  time        DateTime @db.Timestamp()
  locationId  Int
  description String   @db.LongText
  categoryId  Int

  location       Location        @relation(fields: [locationId], references: [id])
  category       Category        @relation(fields: [categoryId], references: [id])
  eventOrganizer Event_Organizer @relation(fields: [eoUsername], references: [username])

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  Ticket            Ticket[]
  Voucher           Voucher[]
  EventImage        EventImage?
  Transaction       Transaction[]
  TransactionDetail TransactionDetail[]
  Use_User_Voucher  Use_User_Voucher[]

  @@map("events")
}

model EventImage {
  id      Int    @id @default(autoincrement())
  url     String
  eventId Int    @unique
  event   Event  @relation(fields: [eventId], references: [id])

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@map("event_images")
}

model Location {
  id      Int    @id @default(autoincrement())
  address String
  city    String
  zip     String

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  Event Event[]

  @@map("event_location")
}

model Ticket {
  id       Int    @id @default(autoincrement())
  eventId  Int
  event    Event  @relation(fields: [eventId], references: [id])
  name     String
  price    Int
  quantity Int

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  Voucher           Voucher[]
  Transaction       Transaction[]
  TransactionDetail TransactionDetail[]

  @@map("event_tickets")
}

model Review {
  id       Int    @id @default(autoincrement())
  userId   String
  user     User   @relation(fields: [userId], references: [uid])
  rating   String
  feedback String

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@map("event_reviews")
}

model Transaction {
  id           Int      @id @default(autoincrement())
  eventId      Int
  userId       String
  ticketType   Int
  voucherUse   String?  @default("no")
  buyDate      DateTime @db.Date
  quantity     Int
  subTotal     Int
  pointUse     Int
  totalPayment Int

  event  Event  @relation(fields: [eventId], references: [id])
  user   User   @relation(fields: [userId], references: [uid])
  ticket Ticket @relation(fields: [ticketType], references: [id])

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  TransactionDetail TransactionDetail[]

  @@map("transactions")
}

model TransactionDetail {
  id            Int      @id @default(autoincrement())
  ticketCode    String
  transactionId Int
  eventId       Int
  userId        String
  ticketType    Int
  buyDate       DateTime @db.Date

  transaction Transaction @relation(fields: [transactionId], references: [id])
  event       Event       @relation(fields: [eventId], references: [id])
  user        User        @relation(fields: [userId], references: [uid])
  ticket      Ticket      @relation(fields: [ticketType], references: [id])

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@map("transactions_detail")
}

model Promotion {
  id        Int     @id @default(autoincrement())
  userId    String
  user      User    @relation(fields: [userId], references: [uid])
  voucherId Int
  voucher   Voucher @relation(fields: [voucherId], references: [id])

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@map("event_promotions")
}

model Voucher {
  id              Int    @id @default(autoincrement())
  name            String
  code            String
  eventId         Int
  event           Event  @relation(fields: [eventId], references: [id])
  ticketId        Int
  ticket          Ticket @relation(fields: [ticketId], references: [id])
  discountVoucher Int    @default(10)
  stok            Int

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  Promotion Promotion[]

  @@map("event_vouchers")
}

model User_Voucher {
  id                Int                 @id @default(autoincrement())
  userId            String
  voucherCode       String
  discountInPercent Int                 @default(10)
  expireAt          DateTime            @db.Date
  status            User_Voucher_Status @default(ACTIVE)

  user User @relation(fields: [userId], references: [uid])

  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  deletedAt        DateTime?
  Use_User_Voucher Use_User_Voucher[]

  @@map("user_voucher")
}

enum User_Voucher_Status {
  EXPIRED
  ACTIVE
  USED
}

model Category {
  id   Int    @id @default(autoincrement())
  name String

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  Event Event[]

  @@map("event_categories")
}

model Use_User_Voucher {
  id        Int    @id @default(autoincrement())
  eventId   Int
  userId    String
  voucherId Int

  event        Event        @relation(fields: [eventId], references: [id])
  user         User         @relation(fields: [userId], references: [uid])
  user_voucher User_Voucher @relation(fields: [voucherId], references: [id])

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@map("use_user_voucher")
}
